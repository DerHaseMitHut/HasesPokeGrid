<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HasesPokéGrid</title>

  <style>
    :root{
      --stageH: min(920px, calc(100vh - 44px));
      --stageW: min(1220px, calc(100vw - 420px));
      --labelW: 170px;
      --headerH: 96px;
      --gap: 12px;

      --bg1:#031022;
      --bg2:#04346A;
      --bg3:#0669B6;

      --accentCyan:#38D6FF;
      --accentBlue:#2A7BFF;
      --accentYellow:#FFD24A;

      --line:rgba(255,255,255,.14);
      --text:#F3FAFF;
      --muted:#B7D4FF;

      --shadow: 0 22px 90px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden;

      background:
        radial-gradient(1100px 700px at 20% 15%, rgba(56,214,255,.26), transparent 55%),
        radial-gradient(900px 700px at 78% 70%, rgba(42,123,255,.22), transparent 58%),
        radial-gradient(700px 550px at 88% 25%, rgba(255,210,74,.10), transparent 62%),
        linear-gradient(160deg, var(--bg1), var(--bg2) 55%, var(--bg3));
    }

    body:before{
      content:"";
      position:fixed; inset:0;
      background:
        repeating-linear-gradient(0deg, rgba(255,255,255,.055) 0 1px, transparent 1px 34px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.055) 0 1px, transparent 1px 34px),
        radial-gradient(1000px 700px at 15% 80%, rgba(56,214,255,.10), transparent 60%),
        radial-gradient(900px 650px at 85% 20%, rgba(42,123,255,.10), transparent 60%);
      opacity:.55;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    #bgLayer{
      position: fixed;
      inset: 0;
      z-index: -5;
      pointer-events: none;
      background-position: center;
      background-repeat: no-repeat;
      background-size: cover;
      opacity: 0;
      transform: scale(1.03);
      transition: opacity .25s ease;
      mix-blend-mode: soft-light;
    }

    .wrap{
      display:grid;
      grid-template-columns: auto 340px;
      gap:18px;
      padding:22px;
      height:100%;
      align-items:start;
    }

    .stage{
      width: var(--stageW);
      height: var(--stageH);
      border:1px solid var(--line);
      border-radius:24px;
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      padding:18px;
      overflow:hidden;
      position:relative;
      isolation:isolate;
    }

    .gridframe{
      position:relative;
      z-index:2;
      display:grid;
      grid-template-columns: var(--labelW) repeat(5, minmax(0, 1fr));
      grid-template-rows: var(--headerH) repeat(5, minmax(0, 1fr));
      gap: var(--gap);
      height:100%;
      width:100%;
      min-width:0;
      min-height:0;
    }

    .cornerInfo{
      border-radius:18px;
      background: rgba(255,255,255,.055);
      border:1px solid rgba(255,255,255,.14);
      padding:12px 12px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:flex-start;
      overflow:hidden;
      user-select:none;
      box-shadow: 0 0 0 1px rgba(255,210,74,.18) inset;
    }
    .cornerTitle{
      font-weight:900;
      letter-spacing:1.2px;
      font-size:12px;
      color: rgba(255,255,255,.78);
      text-transform:uppercase;
    }
    .cornerValue{
      margin-top:6px;
      font-weight:950;
      font-size:28px;
      letter-spacing:.5px;
      color: rgba(255,255,255,.96);
      text-shadow: 0 10px 30px rgba(0,0,0,.45);
    }

    .hdr, .rowhdr{
      border-radius:18px;
      background: rgba(255,255,255,.065);
      border:1px solid rgba(255,255,255,.14);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      user-select:none;
      min-width:0;
      overflow:hidden;
      box-shadow: 0 0 0 1px rgba(255,210,74,.18) inset;
    }

    .hdrText, .rowhdrText{
      width:100%;
      max-width:100%;
      min-width:0;
      text-transform:uppercase;
      letter-spacing:1.4px;
      font-weight:900;
      font-size:18px;
      line-height:1.08;
      white-space:normal;
      overflow:hidden;
      display:block;
      padding: 2px 0;

      word-break: normal;
      overflow-wrap: normal;
      hyphens: auto;
      -webkit-hyphens: auto;
      -ms-hyphens: auto;
    }

    .hdrText[contenteditable="true"],
    .rowhdrText[contenteditable="true"]{
      outline: 2px solid rgba(56,214,255,.38);
      border-radius:10px;
      padding:4px 6px;
      background: rgba(255,255,255,.08);
    }

    .cell{
      border-radius:20px;
      background: rgba(255,255,255,.045);
      border:1px solid rgba(255,255,255,.11);
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
      min-width:0;
      min-height:0;
    }
    .cell:hover{ border-color: rgba(255,255,255,.18); }

    .cell.marked{
      background: rgba(255,210,74,.22);
      border-color: rgba(255,210,74,.55);
      box-shadow:
        0 0 0 2px rgba(255,210,74,.18) inset,
        0 16px 34px rgba(255,210,74,.18);
    }

    .cell.selected{
      background: rgba(56,214,255,.18);
      border-color: rgba(56,214,255,.45);
      box-shadow:
        0 0 0 2px rgba(56,214,255,.14) inset,
        0 14px 34px rgba(42,123,255,.18);
    }

    .cell.delete-mode{ border-color: rgba(255,110,110,.28); }

    .cell.comm-hit::before{
      content:"";
      position:absolute;
      inset:0;
      background: rgba(56,214,255, var(--commAlpha, 0));
      pointer-events:none;
      z-index:1;
    }

    .commBadgeWrap{ position:absolute; top:8px; right:8px; z-index:8; }
    .commBadge{
      padding:4px 7px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      line-height:1;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.95);
      user-select:none;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:24px;
    }

    .commTip{
      position:absolute;
      top: calc(100% + 8px);
      right: 0;
      width: max-content;
      max-width: 220px;
      padding:10px 10px;
      border-radius:14px;
      background: rgba(12,14,22,.92);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      color: rgba(255,255,255,.94);
      font-size:12px;
      line-height:1.25;
      letter-spacing:.2px;
      display:none;
      pointer-events:none;
      white-space:pre-line;
    }
    .commTip:before{
      content:"";
      position:absolute;
      top:-6px;
      right:14px;
      width:10px;
      height:10px;
      background: rgba(12,14,22,.92);
      border-left: 1px solid rgba(255,255,255,.18);
      border-top: 1px solid rgba(255,255,255,.18);
      transform: rotate(45deg);
    }
    .commTip .tTitle{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:1.1px;
      color: rgba(255,255,255,.72);
      font-size:10px;
      margin-bottom:6px;
    }
    .commBadgeWrap:hover .commTip{ display:block; }

    .cell img{
      width: 98%;
      height: 98%;
      object-fit: contain;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.42));
      transform: scale(1.08);
      z-index:2;
    }
    .cell .hint{
      color: rgba(255,255,255,.28);
      font-weight:800;
      letter-spacing:.8px;
      font-size:12px;
      text-transform:uppercase;
      user-select:none;
      z-index:2;
    }

    .sparkle{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index:5;
    }
    .sparkle img{
      width: 120%;
      height: 120%;
      object-fit: contain;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }

    .panel{
      border:1px solid var(--line);
      border-radius:24px;
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      padding:16px;
      position:relative;
      height: fit-content;
      overflow: visible;
      isolation:isolate;
    }

    .panel h2{
      margin:0 0 10px 0;
      font-size:16px;
      letter-spacing:.6px;
    }
    .btn{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(42,123,255,.10);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.3px;
    }
    .btn:hover{ background: rgba(42,123,255,.14); }
    .btn.danger{
      background: rgba(255,110,110,.18);
      border-color: rgba(255,110,110,.25);
    }
    .btn.danger:hover{ background: rgba(255,110,110,.22); }
    .btn.secondary{
      background: rgba(56,214,255,.14);
      border-color: rgba(56,214,255,.28);
    }
    .btn.secondary:hover{
      background: rgba(56,214,255,.18);
      box-shadow: 0 0 0 2px rgba(255,210,74,.12) inset, 0 14px 30px rgba(255,210,74,.10);
    }
    .btn.small{ padding:10px 12px; font-weight:800; font-size:14px; }

    .stack{ display:grid; gap:10px; }
    .field{ position:relative; z-index:2; }
    input{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
      font-size:15px;
    }
    input:focus{
      border-color: rgba(56,214,255,.35);
      box-shadow: 0 0 0 3px rgba(56,214,255,.12);
    }
    .muted{ color:var(--muted); font-size:12px; line-height:1.35; }
    .toast{ min-height:18px; color:var(--muted); font-size:13px; }

    .dd{
      position:absolute; left:0; right:0; top:48px;
      background: rgba(16,18,30,.98);
      border:1px solid rgba(255,255,255,.18);
      border-radius:14px;
      overflow:hidden;
      max-height:260px;
      display:none;
      backdrop-filter: blur(8px);
      z-index:50;
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
    }
    .dd.show{ display:block; }
    .dd button{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border:0;
      background: transparent;
      color: var(--text);
      cursor:pointer;
      font-size:14px;
    }
    .dd button:hover, .dd button.active{ background: rgba(56,214,255,.16); }

    input[type="range"]{
      width:100%;
      accent-color: var(--accentYellow);
      height: 20px;
    }

    .presenter .panel{ display:none; }
    .presenter .wrap{ grid-template-columns: auto; }

    #otherTip{
      position: fixed;
      z-index: 9999;
      display: none;
      max-width: 360px;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(12,14,22,.92);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.94);
      pointer-events: none;
    }
    #otherTip .otTitle{
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 1.1px;
      color: rgba(255,255,255,.72);
      font-size: 11px;
      margin-bottom: 8px;
    }
    #otherTip .otList{
      font-size: 13px;
      line-height: 1.25;
      white-space: pre-line;
    }
    #otherTip .otRow{
      margin: 7px 0;
      padding-top: 7px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    #otherTip .otRow:first-child{ margin-top:0; padding-top:0; border-top:0; }
    #otherTip .otMon{ font-weight: 950; }
    #otherTip .otMeta{
      color: rgba(255,255,255,.72);
      font-size: 12px;
      margin-top: 2px;
      white-space: pre-line;
    }
  </style>
</head>

<body>
  <div id="bgLayer"></div>

  <div class="wrap">
    <div class="stage">
      <div class="gridframe">
        <div class="cornerInfo">
          <div class="cornerTitle">Communityscore</div>
          <div class="cornerValue" id="cornerScore">0</div>
        </div>

        <div class="hdr"><span class="hdrText">SPALTE 1</span></div>
        <div class="hdr"><span class="hdrText">SPALTE 2</span></div>
        <div class="hdr"><span class="hdrText">SPALTE 3</span></div>
        <div class="hdr"><span class="hdrText">SPALTE 4</span></div>
        <div class="hdr"><span class="hdrText">SPALTE 5</span></div>

        <div class="rowhdr"><span class="rowhdrText">ZEILE 1</span></div>
        <div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div>

        <div class="rowhdr"><span class="rowhdrText">ZEILE 2</span></div>
        <div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div>

        <div class="rowhdr"><span class="rowhdrText">ZEILE 3</span></div>
        <div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div>

        <div class="rowhdr"><span class="rowhdrText">ZEILE 4</span></div>
        <div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div>

        <div class="rowhdr"><span class="rowhdrText">ZEILE 5</span></div>
        <div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div><div class="cell"><div class="hint">leer</div></div>
      </div>
    </div>

    <div class="panel">
      <h2>Controls</h2>
      <div class="stack">
        <div class="muted" id="autoStatus">Status: lädt…</div>
        <div class="muted" id="commStatus">Community-Datensätze: 0</div>

        <div class="field">
          <input id="pokeInput" placeholder="Pokémon eingeben (Deutsch)…" autocomplete="off" />
          <div class="dd" id="dd"></div>
        </div>

        <button class="btn" id="randomBtn">Zufälliges leeres Feld</button>
        <button class="btn danger" id="deleteBtn">Löschen</button>
        <button class="btn danger" id="resetBtn">Reset (Zellen leeren)</button>

        <button class="btn secondary" id="exportBtn">Export (meine Lösung)</button>
        <button class="btn secondary" id="importCommBtn">Import Community (additiv)</button>
        <button class="btn small" id="clearCommBtn">Community löschen</button>

        <button class="btn secondary" id="otherHoverBtn">Community-Antworten: AUS</button>

        <button class="btn secondary" id="bgPickBtn">Hintergrund wählen</button>
        <button class="btn small" id="bgClearBtn">Hintergrund zurücksetzen</button>

        <button class="btn" id="presenterBtn">Presenter Mode (H)</button>

        <div class="muted">Cry-Lautstärke</div>
        <input id="cryVol" type="range" min="0" max="100" value="25" />

        <div class="muted">Shiny-Lautstärke</div>
        <input id="shinyVol" type="range" min="0" max="100" value="55" />

        <div class="toast" id="toast"></div>
      </div>
    </div>
  </div>

  <div id="otherTip">
    <div class="otTitle">Community-Antworten (andere)</div>
    <div class="otList"></div>
  </div>

  <script>
    // ========= HOSTED CONFIG (FEST) =========
    const GITHUB_USER = "DerHaseMitHut";
    const ASSETS_REPO = "HasesPokeGrid-Assets";
    const ASSET_BASE = `https://cdn.jsdelivr.net/gh/${GITHUB_USER}/${ASSETS_REPO}@main`;

    const MAPPING_URL = `./dex_de.json`;
    const PRESET_URL  = `./grid_preset.json`;

    const IMG_URL       = (id) => `${ASSET_BASE}/pokemon/${id}.png`;
    const SHINY_IMG_URL = (id) => `${ASSET_BASE}/pokemon/shiny/${id}.png`;
    const CRY_URL       = (id) => `${ASSET_BASE}/Pokemon%20Cries/${id}.ogg`;

    const SHINY_SPARKLE_URL = `${ASSET_BASE}/ShinySparkle.gif`;
    const SHINY_SOUND_URL   = `${ASSET_BASE}/ShinySound.mp3`;

    // ========= CONFIG =========
    const SHINY_CHANCE = 0.05;
    const SPARKLE_DURATION_MS = 1000;

    const LS_CRY_VOL = 'pokegrid_cry_vol';
    const LS_SHINY_VOL = 'pokegrid_shiny_vol';

    // ========= State =========
    let dex = [];
    let dexByKey = new Map();

    let selectedCell = null;
    let deleteMode = false;
    let presenter = false;

    let communityDatasetCount = 0;
    const communityCounts = new Map();
    const communityNames = new Map();
    let communityMaxCount = 0;

    const communityCellIndex = new Map();
    let otherHoverMode = false;

    let shinyAudio = new Audio();
    const cryAudio = new Audio();

    const toastEl = document.getElementById('toast');
    const autoStatus = document.getElementById('autoStatus');
    const commStatus = document.getElementById('commStatus');
    const scoreEl = document.getElementById('cornerScore');

    const cells = Array.from(document.querySelectorAll('.cell'));
    const headerSpans = Array.from(document.querySelectorAll('.hdrText, .rowhdrText'));
    const input = document.getElementById('pokeInput');
    const dd = document.getElementById('dd');
    const bgLayer = document.getElementById('bgLayer');

    const cryVolEl = document.getElementById('cryVol');
    const shinyVolEl = document.getElementById('shinyVol');

    const otherTip = document.getElementById('otherTip');
    const otherTipList = otherTip.querySelector('.otList');

    function toast(msg){
      toastEl.textContent = msg || '';
      if (msg) setTimeout(() => { if (toastEl.textContent === msg) toastEl.textContent=''; }, 2400);
    }
    function setStatus(text){ autoStatus.textContent = text; }
    function setCommStatus(){ commStatus.textContent = `Community-Datensätze: ${communityDatasetCount}`; }

    function clamp01(v){ return Math.max(0, Math.min(1, v)); }

    function loadVolumePrefs(){
      const c = localStorage.getItem(LS_CRY_VOL);
      const s = localStorage.getItem(LS_SHINY_VOL);
      if (c != null) cryVolEl.value = String(Math.max(0, Math.min(100, Number(c))));
      if (s != null) shinyVolEl.value = String(Math.max(0, Math.min(100, Number(s))));
    }
    function applyCryVolume(){
      cryAudio.volume = clamp01(Number(cryVolEl.value ?? 25) / 100);
      localStorage.setItem(LS_CRY_VOL, String(cryVolEl.value));
    }
    function applyShinyVolume(){
      shinyAudio.volume = clamp01(Number(shinyVolEl.value ?? 55) / 100);
      localStorage.setItem(LS_SHINY_VOL, String(shinyVolEl.value));
    }

    loadVolumePrefs();
    applyCryVolume();
    applyShinyVolume();
    cryVolEl.addEventListener('input', applyCryVolume);
    shinyVolEl.addEventListener('input', applyShinyVolume);

    function idxToRC(idx){
      const i = Number(idx);
      return { r: Math.floor(i/5), c: i % 5 };
    }
    function overlayKey(r,c,pokeKey){ return `${r},${c},${pokeKey}`; }

    function normKey(s){
      s = (s||'').trim().toLowerCase().replace(/ß/g,'ss').normalize('NFKD').replace(/[\u0300-\u036f]/g,'');
      s = s.replace(/[^a-z0-9\s\-']/g,' ').replace(/-/g,' ').replace(/\s+/g,' ').trim();
      return s;
    }

    function baseNameNoExt(filename){
      return String(filename || '').split(/[\\/]/).pop().replace(/\.json$/i,'').trim();
    }

    // ===== header fit (shrink until it fits) =====
    const measureEl = document.createElement('div');
    measureEl.style.position = 'fixed';
    measureEl.style.left = '-99999px';
    measureEl.style.top = '0';
    measureEl.style.visibility = 'hidden';
    measureEl.style.pointerEvents = 'none';
    measureEl.style.whiteSpace = 'normal';
    document.body.appendChild(measureEl);

    function fitHeaderText(span, max=18, min=6){
      const parent = span.parentElement;
      const pCS = getComputedStyle(parent);
      const cs = getComputedStyle(span);

      const padX = (parseFloat(pCS.paddingLeft)||0) + (parseFloat(pCS.paddingRight)||0);
      const padY = (parseFloat(pCS.paddingTop)||0) + (parseFloat(pCS.paddingBottom)||0);
      const safe = 8;

      const maxW = Math.max(20, parent.clientWidth  - padX - safe);
      const maxH = Math.max(20, parent.clientHeight - padY - safe);

      measureEl.style.width = maxW + 'px';
      measureEl.style.fontFamily = cs.fontFamily;
      measureEl.style.fontWeight = cs.fontWeight;
      measureEl.style.letterSpacing = cs.letterSpacing;
      measureEl.style.textTransform = cs.textTransform;
      measureEl.style.wordBreak = cs.wordBreak;
      measureEl.style.overflowWrap = cs.overflowWrap;
      measureEl.style.hyphens = cs.hyphens;
      measureEl.style.whiteSpace = 'normal';

      const text = span.textContent;

      for (let size=max; size>=min; size--){
        span.style.fontSize = size + 'px';
        measureEl.style.fontSize = size + 'px';
        measureEl.style.lineHeight = (size * 1.08) + 'px';
        measureEl.textContent = text;
        void measureEl.offsetHeight;
        if (measureEl.scrollHeight <= maxH) return;
      }
      span.style.fontSize = min + 'px';
    }

    function startEditHeader(span){
      if (span.isContentEditable) return;
      span.dataset.prev = span.textContent;
      span.contentEditable = "true";
      span.focus();
      document.execCommand('selectAll', false, null);
    }
    function finishEditHeader(span){
      if (!span.isContentEditable) return;
      span.contentEditable = "false";
      span.textContent = (span.textContent || '').trim() || span.dataset.prev || '—';
      fitHeaderText(span);
    }
    function cancelEditHeader(span){
      if (!span.isContentEditable) return;
      span.textContent = span.dataset.prev || span.textContent;
      span.contentEditable = "false";
      fitHeaderText(span);
    }

    headerSpans.forEach(sp => {
      sp.addEventListener('click', (e) => { e.stopPropagation(); startEditHeader(sp); });
      sp.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { e.preventDefault(); cancelEditHeader(sp); }
        if (e.key === 'Enter')  { e.preventDefault(); sp.blur(); }
      });
      sp.addEventListener('blur', () => finishEditHeader(sp));
    });

    // ===== cells =====
    function selectCell(cell){
      if (selectedCell) selectedCell.classList.remove('selected');
      selectedCell = cell;
      cell.classList.add('selected');
    }
    function isEmpty(cell){ return !cell.dataset.pid; }
    function clearCell(cell){
      cell.dataset.pid = '';
      cell.dataset.pokeKey = '';
      cell.innerHTML = '<div class="hint">leer</div>';
      updateCommunityOverlayForCell(cell);
      recalcCommunityScore();
    }

    cells.forEach((c, idx) => {
      c.dataset.idx = String(idx);

      c.addEventListener('click', () => {
        if (deleteMode){
          if (c.dataset.pid) clearCell(c);
          return;
        }
        selectCell(c);
      });

      c.addEventListener('mouseenter', (e) => {
        if (!otherHoverMode) return;
        if (!c.dataset.pid) return;
        if (communityDatasetCount <= 0) return;

        const html = buildOtherAnswersHtmlForCell(c);
        if (!html){ hideOtherTip(); return; }
        otherTipList.innerHTML = html;
        otherTip.style.display = 'block';
        moveOtherTip(e.clientX, e.clientY);
      });

      c.addEventListener('mousemove', (e) => {
        if (otherTip.style.display === 'block') moveOtherTip(e.clientX, e.clientY);
      });

      c.addEventListener('mouseleave', hideOtherTip);
    });

    function randomEmptyCell(){
      const empties = cells.filter(isEmpty);
      if (!empties.length){ toast('Keine leeren Felder mehr.'); return null; }
      const pick = empties[Math.floor(Math.random()*empties.length)];
      cells.forEach(c => c.classList.remove('marked'));
      pick.classList.add('marked');
      selectCell(pick);
      return pick;
    }

    function resetGrid(){
      cells.forEach(c => {
        c.classList.remove('marked','selected','delete-mode');
        c.dataset.pid = '';
        c.dataset.pokeKey = '';
        c.innerHTML = '<div class="hint">leer</div>';
        updateCommunityOverlayForCell(c);
      });
      deleteMode = false;
      document.getElementById('deleteBtn').textContent = 'Löschen';
      selectCell(cells[0]);
      randomEmptyCell();
      recalcCommunityScore();
    }

    // ===== community overlays =====
    function updateCommunityOverlayForCell(cell){
      const pokeKey = cell.dataset.pokeKey || '';
      const idx = cell.dataset.idx;
      if (!pokeKey || idx == null){
        cell.classList.remove('comm-hit');
        cell.style.removeProperty('--commAlpha');
        const wrap = cell.querySelector('.commBadgeWrap');
        if (wrap) wrap.remove();
        return;
      }

      const {r,c} = idxToRC(idx);
      const k = overlayKey(r,c,pokeKey);
      const count = communityCounts.get(k) || 0;

      if (count <= 0){
        cell.classList.remove('comm-hit');
        cell.style.removeProperty('--commAlpha');
        const wrap = cell.querySelector('.commBadgeWrap');
        if (wrap) wrap.remove();
        return;
      }

      const max = Math.max(1, communityMaxCount);
      const t = Math.min(1, count / max);
      const alpha = 0.06 + t * 0.16;

      cell.classList.add('comm-hit');
      cell.style.setProperty('--commAlpha', String(alpha));

      const set = communityNames.get(k);
      const namesMultiline = set && set.size ? [...set].sort((a,b)=>a.localeCompare(b)).join('\n') : '—';

      let wrap = cell.querySelector('.commBadgeWrap');
      if (!wrap){
        wrap = document.createElement('div');
        wrap.className = 'commBadgeWrap';
        wrap.innerHTML = `
          <div class="commBadge"></div>
          <div class="commTip"><div class="tTitle">Wer hatte das hier?</div><div class="tList"></div></div>
        `;
        cell.appendChild(wrap);
      }
      wrap.querySelector('.commBadge').textContent = String(count);
      wrap.querySelector('.tList').textContent = namesMultiline;
    }

    function refreshAllCommunityOverlays(){
      cells.forEach(c => updateCommunityOverlayForCell(c));
      recalcCommunityScore();
    }

    function recalcCommunityScore(){
      let score = 0;
      for (const cell of cells){
        const pokeKey = cell.dataset.pokeKey || '';
        const idx = cell.dataset.idx;
        if (!pokeKey || idx == null) continue;
        const {r,c} = idxToRC(idx);
        const k = overlayKey(r,c,pokeKey);
        const count = communityCounts.get(k) || 0;
        if (count > 0) score += count;
      }
      scoreEl.textContent = String(score);
    }

    // ===== other answers tooltip =====
    function escapeHtml(s){
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }
    function hideOtherTip(){ otherTip.style.display = 'none'; }
    function moveOtherTip(x,y){
      const pad=14;
      let left=x+pad, top=y+pad;
      otherTip.style.left = left+'px';
      otherTip.style.top  = top+'px';
      const rect = otherTip.getBoundingClientRect();
      left = Math.min(left, window.innerWidth - rect.width - 10);
      top  = Math.min(top,  window.innerHeight - rect.height - 10);
      otherTip.style.left = left+'px';
      otherTip.style.top  = top+'px';
    }

    function getPrettyNameFromKey(pokeKey){ return dexByKey.get(pokeKey) || pokeKey; }

    function buildOtherAnswersHtmlForCell(cell){
      const idx = cell.dataset.idx;
      if (idx == null) return '';
      const {r,c} = idxToRC(idx);
      const cellKey = `${r},${c}`;
      const byMon = communityCellIndex.get(cellKey);
      if (!byMon) return '';
      const currentKey = cell.dataset.pokeKey || '';
      const rows = [];
      for (const [k, rec] of byMon.entries()){
        if (!k || k === currentKey) continue;
        const names = rec.names ? [...rec.names].sort((a,b)=>a.localeCompare(b)) : [];
        rows.push({ name: getPrettyNameFromKey(k), count: rec.count||0, who: names.length?names.join('\n'):'—' });
      }
      if (!rows.length) return '';
      rows.sort((a,b)=> (b.count-a.count) || a.name.localeCompare(b.name));
      return rows.map(r => `
        <div class="otRow">
          <div class="otMon">${escapeHtml(r.name)} <span style="opacity:.75;">(${r.count})</span></div>
          <div class="otMeta">${escapeHtml(r.who)}</div>
        </div>
      `).join('');
    }

    // ===== placing pokemon =====
    function playSparkleOnce(cell){
      const old = cell.querySelector('.sparkle');
      if (old) old.remove();
      const wrap = document.createElement('div');
      wrap.className = 'sparkle';
      const img = document.createElement('img');
      img.src = SHINY_SPARKLE_URL + `#t=${Date.now()}`;
      img.alt = 'Shiny';
      wrap.appendChild(img);
      cell.appendChild(wrap);
      setTimeout(() => wrap.remove(), SPARKLE_DURATION_MS);
    }

    function playShinySoundAndThen(fnAfter){
      try{
        shinyAudio.pause();
        shinyAudio.currentTime = 0;
        const onEnd = () => { shinyAudio.removeEventListener('ended', onEnd); fnAfter?.(); };
        shinyAudio.addEventListener('ended', onEnd);
        const p = shinyAudio.play();
        if (p && p.catch) p.catch(() => { shinyAudio.removeEventListener('ended', onEnd); setTimeout(()=>fnAfter?.(), SPARKLE_DURATION_MS); });
      }catch{
        setTimeout(()=>fnAfter?.(), SPARKLE_DURATION_MS);
      }
    }

    async function playCry(id){
      try{
        cryAudio.pause();
        cryAudio.currentTime = 0;
        cryAudio.src = CRY_URL(id);
        applyCryVolume();
        await cryAudio.play();
      }catch{}
    }

    async function loadImageUrlById(id, wantShiny){
      return wantShiny ? SHINY_IMG_URL(id) : IMG_URL(id);
    }

    async function placePokemon(entry){
      if (!entry) return;
      if (!selectedCell) randomEmptyCell();
      if (!selectedCell) return;

      const wantShiny = Math.random() < SHINY_CHANCE;
      const url = await loadImageUrlById(entry.id, wantShiny);

      selectedCell.dataset.pid = String(entry.id);
      selectedCell.dataset.pokeKey = String(entry.key || normKey(entry.display || ''));

      selectedCell.innerHTML = '';
      const img = document.createElement('img');
      img.alt = entry.display;
      img.src = url;
      selectedCell.appendChild(img);

      updateCommunityOverlayForCell(selectedCell);
      recalcCommunityScore();

      if (wantShiny){
        playSparkleOnce(selectedCell);
        playShinySoundAndThen(() => playCry(entry.id));
      } else {
        playCry(entry.id);
      }
    }

    // ===== autocomplete =====
    let ddIndex = -1;
    function hideDD(){ dd.classList.remove('show'); dd.innerHTML=''; ddIndex=-1; }
    function showDD(items){
      dd.innerHTML = '';
      items.forEach((it, idx) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = it.display;
        b.addEventListener('click', () => {
          input.value = it.display;
          hideDD();
          placePokemon(it);
          input.focus();
          input.select();
        });
        if (idx === 0) b.classList.add('active');
        dd.appendChild(b);
      });
      dd.classList.add('show');
      ddIndex = 0;
    }
    function searchDex(q){
      q = normKey(q);
      if (!q || !dex.length) return [];
      const starts = [];
      const contains = [];
      for (const e of dex){
        const k = e.key || '';
        if (k.startsWith(q)) starts.push(e);
        else if (k.includes(q)) contains.push(e);
        if (starts.length + contains.length >= 24) break;
      }
      return starts.concat(contains).slice(0, 12);
    }
    input.addEventListener('input', () => {
      const items = searchDex(input.value);
      if (!items.length){ hideDD(); return; }
      showDD(items);
    });
    input.addEventListener('keydown', (e) => {
      if (!dd.classList.contains('show')){
        if (e.key === 'Enter'){
          const q = normKey(input.value);
          const exact = dex.find(x => (x.key||'') === q) || null;
          if (exact) placePokemon(exact);
        }
        return;
      }
      const buttons = Array.from(dd.querySelectorAll('button'));
      if (e.key === 'ArrowDown'){ e.preventDefault(); ddIndex = Math.min(ddIndex+1, buttons.length-1); }
      else if (e.key === 'ArrowUp'){ e.preventDefault(); ddIndex = Math.max(ddIndex-1, 0); }
      else if (e.key === 'Enter'){ e.preventDefault(); buttons[ddIndex]?.click(); return; }
      else if (e.key === 'Escape'){ e.preventDefault(); hideDD(); return; }

      buttons.forEach(b => b.classList.remove('active'));
      buttons[ddIndex]?.classList.add('active');
      buttons[ddIndex]?.scrollIntoView({block:'nearest'});
    });
    document.addEventListener('click', (e) => { if (!e.target.closest('.field')) hideDD(); });

    // ===== export/import community =====
    function downloadJson(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    function exportMySolution(){
      const cellsOut = [];
      cells.forEach((cell) => {
        const pid = cell.dataset.pid || '';
        const pokeKey = cell.dataset.pokeKey || '';
        if (!pid || !pokeKey) return;
        const idx = cell.dataset.idx;
        const {r,c} = idxToRC(idx);
        cellsOut.push({ r, c, id: Number(pid), key: pokeKey });
      });

      const presetCols = Array.from(document.querySelectorAll('.hdr .hdrText')).map(s => s.textContent);
      const presetRows = Array.from(document.querySelectorAll('.rowhdr .rowhdrText')).map(s => s.textContent);

      const payload = {
        version: 1,
        createdAt: new Date().toISOString(),
        gridSize: 5,
        columns: presetCols,
        rows: presetRows,
        cells: cellsOut
      };

      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      downloadJson(payload, `pokegrid_solution_${stamp}.json`);
    }

    function addCommunityDataset(dataset, who){
      if (!dataset || !Array.isArray(dataset.cells)) return;
      for (const it of dataset.cells){
        const r = Number(it.r), c = Number(it.c);
        const key = String(it.key || '').trim();
        if (!Number.isFinite(r) || !Number.isFinite(c) || !key) continue;
        if (r<0||r>4||c<0||c>4) continue;

        const mapKey = overlayKey(r,c,key);
        const next = (communityCounts.get(mapKey) || 0) + 1;
        communityCounts.set(mapKey, next);
        communityMaxCount = Math.max(communityMaxCount, next);

        const set = communityNames.get(mapKey) || new Set();
        if (who) set.add(who);
        communityNames.set(mapKey, set);

        const cellKey = `${r},${c}`;
        let byMon = communityCellIndex.get(cellKey);
        if (!byMon){ byMon = new Map(); communityCellIndex.set(cellKey, byMon); }
        let rec = byMon.get(key);
        if (!rec){ rec = { count:0, names:new Set() }; byMon.set(key, rec); }
        rec.count += 1;
        if (who) rec.names.add(who);
      }
    }

    async function importCommunityAdditive(){
      const handles = await window.showOpenFilePicker({
        types: [{ description:'JSON', accept: { 'application/json':['.json'] } }],
        multiple: true
      });
      let loaded = 0;
      for (const fh of handles){
        const file = await fh.getFile();
        const obj = JSON.parse(await file.text());
        addCommunityDataset(obj, baseNameNoExt(file.name));
        loaded++;
      }
      communityDatasetCount += loaded;
      setCommStatus();
      refreshAllCommunityOverlays();
    }

    function clearCommunity(){
      communityDatasetCount = 0;
      communityCounts.clear();
      communityNames.clear();
      communityCellIndex.clear();
      communityMaxCount = 0;
      setCommStatus();
      refreshAllCommunityOverlays();
      hideOtherTip();
    }

    // ===== controls =====
    document.getElementById('randomBtn').addEventListener('click', randomEmptyCell);

    const deleteBtn = document.getElementById('deleteBtn');
    function setDeleteMode(on){
      deleteMode = on;
      deleteBtn.textContent = on ? 'Abbrechen' : 'Löschen';
      cells.forEach(c => c.classList.toggle('delete-mode', on));
    }
    deleteBtn.addEventListener('click', () => setDeleteMode(!deleteMode));

    document.getElementById('resetBtn').addEventListener('click', () => {
      if (confirm('Wirklich alle Zellen leeren? (Titel bleiben)')) resetGrid();
    });

    document.getElementById('exportBtn').addEventListener('click', exportMySolution);
    document.getElementById('importCommBtn').addEventListener('click', importCommunityAdditive);
    document.getElementById('clearCommBtn').addEventListener('click', () => {
      if (confirm('Community-Daten wirklich löschen?')) clearCommunity();
    });

    const presenterBtn = document.getElementById('presenterBtn');
    function togglePresenter(){
      presenter = !presenter;
      document.body.classList.toggle('presenter', presenter);
      hideOtherTip();
    }
    presenterBtn.addEventListener('click', togglePresenter);

    const otherHoverBtn = document.getElementById('otherHoverBtn');
    function updateOtherHoverBtn(){
      otherHoverBtn.textContent = `Community-Antworten: ${otherHoverMode ? 'AN' : 'AUS'}`;
    }
    otherHoverBtn.addEventListener('click', () => {
      otherHoverMode = !otherHoverMode;
      updateOtherHoverBtn();
      hideOtherTip();
    });
    updateOtherHoverBtn();

    // init UI
    selectCell(cells[0]);
    randomEmptyCell();
    setCommStatus();
    recalcCommunityScore();

    window.addEventListener('resize', () => headerSpans.forEach(sp => fitHeaderText(sp)));

    // ===== Hosted init =====
    async function initHosted(){
      try{
        setStatus('Status: lädt Daten…');

        const mapRes = await fetch(MAPPING_URL, { cache: "no-store" });
        const mapObj = await mapRes.json();
        dex = Array.isArray(mapObj.entries) ? mapObj.entries : [];
        dexByKey = new Map(dex.map(e => [e.key, e.display]));

        try{
          const preRes = await fetch(PRESET_URL, { cache: "no-store" });
          if (preRes.ok){
            const preset = await preRes.json();
            if (preset){
              const cols = Array.isArray(preset.columns) ? preset.columns : [];
              const rows = Array.isArray(preset.rows) ? preset.rows : [];
              const colSpans = Array.from(document.querySelectorAll('.hdr .hdrText'));
              const rowSpans = Array.from(document.querySelectorAll('.rowhdr .rowhdrText'));
              for (let i=0;i<Math.min(5,colSpans.length,cols.length);i++) colSpans[i].textContent = cols[i] ?? colSpans[i].textContent;
              for (let i=0;i<Math.min(5,rowSpans.length,rows.length);i++) rowSpans[i].textContent = rows[i] ?? rowSpans[i].textContent;
            }
          }
        }catch{}

        shinyAudio = new Audio(SHINY_SOUND_URL);
        applyShinyVolume();

        setStatus(`Eingerichtet ✅ (${dex.length} Einträge)`);
        headerSpans.forEach(sp => fitHeaderText(sp));
        toast('Bereit.');
      }catch(err){
        console.error(err);
        setStatus('Fehler: Daten konnten nicht geladen werden');
        toast('Bitte prüfe: dex_de.json & grid_preset.json im Pages-Repo.');
      }
    }

    initHosted();
  </script>
</body>
</html>
